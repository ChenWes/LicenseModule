name: Build and Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾ï¼Œå¦‚ v1.0.0

jobs:
  build:
    name: Build Cross Platform Binaries
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            suffix: ""
          - goos: linux
            goarch: arm64
            suffix: ""
          - goos: darwin
            goarch: amd64
            suffix: ""
          - goos: darwin
            goarch: arm64
            suffix: ""
          - goos: windows
            goarch: amd64
            suffix: ".exe"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'

    - name: Get dependencies
      run: |
        go mod download
        go mod tidy
    - name: Extract version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "Build version: ${VERSION}"
    - name: Build binary
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
      run: |
        mkdir -p bin
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
        GIT_COMMIT=$(git rev-parse --short HEAD)
        
        # å®šä¹‰æ–‡ä»¶ååç¼€
        EXT="${{ matrix.suffix }}"
        
        # ä¸º Linux å¹³å°è®¾ç½® CGO_ENABLED=0 ä»¥æ”¯æŒ Alpine Linux (musl libc)
        # é™æ€ç¼–è¯‘ï¼Œä¸ä¾èµ– glibcï¼Œå¯ä»¥åœ¨ Alpine ä¸Šè¿è¡Œ
        if [ "${{ matrix.goos }}" = "linux" ]; then
          export CGO_ENABLED=0
        fi
        
        # 1. æ„å»º Verify (æ‰€æœ‰å¹³å°)
        go build -ldflags="${LDFLAGS}" -o "bin/cf-license-verify-${VERSION}-${{ matrix.goos }}-${{ matrix.goarch }}${EXT}" cmd/license/verify/main.go
        # 2. æ„å»º API æœåŠ¡
        go build -ldflags="${LDFLAGS}" -o "bin/cf-license-server-${VERSION}-${{ matrix.goos }}-${{ matrix.goarch }}${EXT}" api/server.go
        
        # 3. æ„å»º Generate (å¦‚æœä½ å¸Œæœ›æ‰€æœ‰å¹³å°éƒ½æœ‰ï¼Œå°±ç§»å‡º if å—)
        # è¿™é‡Œä»¥ Linux ä¸ºä¾‹ï¼Œå¦‚æœä½ éœ€è¦å…¨å¹³å°ï¼Œè¯·å»æ‰ä¸‹é¢çš„ if åˆ¤æ–­
        if [ "${{ matrix.goos }}" = "linux" ]; then
          go build -ldflags="${LDFLAGS}" -o "bin/cf-license-generate-${VERSION}-${{ matrix.goos }}-${{ matrix.goarch }}${EXT}" cmd/license/generate/main.go          
        fi
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: cf-license-artifacts-${{ matrix.goos }}-${{ matrix.goarch }}
        path:          
          bin/cf-license-*          
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Extract version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "Release version: ${VERSION}"
    - name: Prepare release assets
      run: |
        mkdir -p release
        # In v4, artifacts are downloaded to subdirectories named after the artifact
        find artifacts -name "cf-license-*" -type f -exec cp {} release/ \;
        ls -la release/
    - name: Generate checksums
      run: |
        cd release
        sha256sum * > checksums.txt
        cat checksums.txt
    - name: Generate Release Notes
      id: release_notes
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.RELEASE_TOKEN }}
        script: |
          const { data: releases } = await github.rest.repos.listReleases({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 1
          });
          
          const previousTag = releases.length > 0 ? releases[0].tag_name : null;
          const currentTag = '${{ steps.get_version.outputs.VERSION }}';
          
          let releaseNotes = '';
          
          if (previousTag) {
            // è·å–è‡ªåŠ¨ç”Ÿæˆçš„ release notes
            const { data: generatedNotes } = await github.rest.repos.generateReleaseNotes({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: currentTag,
              previous_tag_name: previousTag
            });
            releaseNotes = generatedNotes.body;
          }
          
          // æ·»åŠ è‡ªå®šä¹‰å†…å®¹
          const customContent = `## Cuifeng License Module ${currentTag}
          ### ğŸš€ æ–°ç‰ˆæœ¬å‘å¸ƒ
          
          Cuifeng License Module çš„ ${currentTag} ç‰ˆæœ¬ã€‚
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š
          
          - **Linux AMD64**: \`cf-license-verify-${currentTag}-linux-amd64\`
          - **Linux ARM64**: \`cf-license-verify-${currentTag}-linux-arm64\` 
          - **macOS Intel**: \`cf-license-verify-${currentTag}-darwin-amd64\`
          - **macOS Apple Silicon**: \`cf-license-verify-${currentTag}-darwin-arm64\`
          - **Windows**: \`cf-license-verify-${currentTag}-windows-amd64.exe\`
          
          ### ğŸ” æ–‡ä»¶æ ¡éªŒ
          
          è¯·ä½¿ç”¨ \`checksums.txt\` æ–‡ä»¶éªŒè¯ä¸‹è½½æ–‡ä»¶çš„å®Œæ•´æ€§ã€‚
          
          ### ğŸ“‹ ä½¿ç”¨æ–¹æ³•
          
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
          2. èµ‹äºˆæ‰§è¡Œæƒé™ï¼ˆLinux/macOSï¼‰ï¼š\`chmod +x cf-license-verify-${currentTag}-*\`
          3. è¿è¡Œï¼š\`./cf-license-verify-${currentTag}-*\` æˆ– \`cf-license-verify-${currentTag}-windows-amd64.exe\`
          
          ### ğŸ“– æ›´å¤šä¿¡æ¯
          
          è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒé¡¹ç›® README.md æ–‡ä»¶ã€‚
          
          ---
          
          ${releaseNotes}`;
          
          core.setOutput('body', customContent);
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        name: Release ${{ steps.get_version.outputs.VERSION }}
        body: ${{ steps.release_notes.outputs.body }}
        files: |
          release/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
